"use strict";(self.webpackChunkfate_weaver=self.webpackChunkfate_weaver||[]).push([[969],{969:()=>{function t(e){return t="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},t(e)}function e(e){var o=function(e,o){if("object"!=t(e)||!e)return e;var a=e[Symbol.toPrimitive];if(void 0!==a){var r=a.call(e,o||"default");if("object"!=t(r))return r;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===o?String:Number)(e)}(e,"string");return"symbol"==t(o)?o:o+""}function o(t,o,a){return(o=e(o))in t?Object.defineProperty(t,o,{value:a,enumerable:!0,configurable:!0,writable:!0}):t[o]=a,t}function a(t,e){var o=Object.keys(t);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(t);e&&(a=a.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),o.push.apply(o,a)}return o}function r(t){for(var e=1;e<arguments.length;e++){var r=null!=arguments[e]?arguments[e]:{};e%2?a(Object(r),!0).forEach((function(e){o(t,e,r[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(r)):a(Object(r)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(r,e))}))}return t}const n=Object.keys({GainIntrigue2:"\u5bc6\u8c0b +2",GainIntrigue:"\u5bc6\u8c0b +1",UselessLocationCover:"\u5730\u70b9\u4f2a\u88c5",DiagonalMove:"\u659c\u5411\u79fb\u52a8",VerticalMove:"\u2191\u2193 \u79fb\u52a8",HorizontalMove:"\u2190\u2192 \u79fb\u52a8",GainParanoia:"\u4e0d\u5b89 +1",LoseParanoia:"\u4e0d\u5b89 -1",ForbidParanoia:"\u7981\u6b62\u4e0d\u5b89",ForbidGoodwill:"\u7981\u6b62\u53cb\u597d"}),i=Object.keys({ForbidMove:"\u7981\u6b62\u79fb\u52a8",GainGoodwill2:"\u53cb\u597d +2",LoseParanoia:"\u4e0d\u5b89 -1",ForbidIntrigue:"\u7981\u6b62\u5bc6\u8c0b",VerticalMove:"\u2191\u2193 \u79fb\u52a8",HorizontalMove:"\u2190\u2192 \u79fb\u52a8",GainGoodwill:"\u53cb\u597d +1",GainParanoia:"\u4e0d\u5b89 +1"}),s=Object.keys({Hospital:"\u533b\u9662",Shrine:"\u795e\u793e",City:"\u90fd\u5e02",School:"\u5b66\u6821"});Object.keys({BoyStudent:"\u7537\u5b66\u751f",GirlStudent:"\u5973\u5b66\u751f",RichMansDaughter:"\u5927\u5c0f\u59d0",ClassRep:"\u73ed\u957f",MysteryBoy:"\u5c40\u5916\u4eba",ShrineMaiden:"\u5deb\u5973",Alien:"\u5f02\u754c\u4eba",GodlyBeing:"\u795e\u7075",PoliceOfficer:"\u5211\u8b66",OfficeWorker:"\u804c\u5458",Informer:"\u60c5\u62a5\u5546",PopIdol:"\u5076\u50cf",Journalist:"\u5a92\u4f53\u4eba",Boss:"\u5927\u4eba\u7269",Doctor:"\u533b\u751f",Patient:"\u4f4f\u9662\u60a3\u8005",Nurse:"\u62a4\u58eb",Henchman:"\u624b\u4e0b",IdentificationOfficer:"\u9274\u522b\u5458",ArmyMan:"\u519b\u4eba",UnlockedPatient:"\u5df2\u5eb7\u590d\u60a3\u8005"});function c(t,e){for(const o of s)if(e.locations[o].characters.includes(t))return o}const l={paranoiaGreaterThan:(t,e)=>function(t,e){const o=t[0],a=t[1];return e.characterStats[o].paranoia>a}(t,e),intrigueGreaterThan:(t,e)=>function(t,e){const o=t[0],a=t[1];return s.includes(o)?e.locations[o].intrigue>a:e.characterStats[o].intrigue>a}(t,e),goodwillGreaterThan:(t,e)=>function(t,e){const o=t[0],a=t[1];return e.characterStats[o].goodwill>a}(t,e),someoneInSomewhere:(t,e)=>function(t,e){const o=t[0],a=t[1];return c(o,e)===a}(t,e),someoneInSameLocationAs:(t,e)=>function(t,e){const o=t[0],a=t[1],r=c(o,e);return!!r&&r===c(a,e)}(t,e),numberShareLocationGreaterThan:(t,e)=>function(t,e){const o=t[0],a=t[1],r=c(o,e);return!!r&&e.locations[r].characters.filter((t=>e.characterStats[t].alive)).filter((t=>t!==o)).length>a}(t,e),numberShareLocationEquals:(t,e)=>function(t,e){const o=t[0],a=t[1],r=c(o,e);return!!r&&e.locations[r].characters.filter((t=>e.characterStats[t].alive)).filter((t=>t!==o)).length===a}(t,e),and:(t,e,o)=>{const a=t[0],r=t[1];return o(a)&&o(r)},or:(t,e,o)=>{const a=t[0],r=t[1];return o(a)||o(r)},not:(t,e,o)=>!o(t[0])},u={BoyStudent:[],GirlStudent:[],RichMansDaughter:[],ClassRep:[],MysteryBoy:[],ShrineMaiden:["City"],Alien:["Hospital"],GodlyBeing:[],PoliceOfficer:[],OfficeWorker:["School"],Informer:[],PopIdol:[],Journalist:[],Boss:[],Doctor:[],Patient:["City","School","Shrine"],Nurse:[],Henchman:[],IdentificationOfficer:[],ArmyMan:[],UnlockedPatient:[]};class f{async compute(t){const e=await this.computeNewBoardState(t.mastermindPlacement,t.protagonistPlacement,t.boardState);return await this.computeUtilityValue(e,t.utilities,t.values)}async computeNewBoardState(t,e,o){const a={locations:{},characterStats:{}};for(const c of s)a.locations[c]={characters:[...o.locations[c].characters],intrigue:o.locations[c].intrigue};for(const s in o.characterStats){const t=o.characterStats[s];a.characterStats[s]={paranoia:t.paranoia,goodwill:t.goodwill,intrigue:t.intrigue,alive:t.alive}}const r={};for(const s in t){const e=t[s];for(const t of e){const e=String(t);r[e]||(r[e]=[]),r[e].push({actionId:s,isMaster:!0})}}for(const s in e){const t=e[s];for(const e of t){const t=String(e);r[t]||(r[t]=[]),r[t].push({actionId:s,isMaster:!1})}}const n=t=>{for(const e of s)if(a.locations[e].characters.includes(t))return e},i=(t,e,o)=>{if((u[t]||[]).includes(e))return;const a=n(t);a&&a!==e&&(o.locations[a].characters=o.locations[a].characters.filter((e=>e!==t)),o.locations[e].characters.push(t))};for(const c in r){const t=r[c];if(1===t.length){const{actionId:e}=t[0],o=c;switch(e){case"GainIntrigue2":s.includes(o)?a.locations[o].intrigue+=2:a.characterStats[o].intrigue+=2;break;case"GainIntrigue":s.includes(o)?a.locations[o].intrigue+=1:a.characterStats[o].intrigue+=1;break;case"UselessLocationCover":case"ForbidParanoia":case"ForbidGoodwill":case"ForbidMove":default:break;case"DiagonalMove":if(!s.includes(o)){const t=o,e=n(t);if(!e)break;let r;"Hospital"===e?r="School":"School"===e?r="Hospital":"City"===e?r="Shrine":"Shrine"===e&&(r="City"),r&&i(t,r,a)}break;case"VerticalMove":if(!s.includes(o)){const t=o,e=n(t);if(!e)break;let r;"Hospital"===e?r="City":"City"===e?r="Hospital":"Shrine"===e?r="School":"School"===e&&(r="Shrine"),r&&i(t,r,a)}break;case"HorizontalMove":if(!s.includes(o)){const t=o,e=n(t);if(!e)break;let r;"Hospital"===e?r="Shrine":"Shrine"===e?r="Hospital":"City"===e?r="School":"School"===e&&(r="City"),r&&i(t,r,a)}break;case"GainParanoia":if(s.includes(o))break;a.characterStats[o].paranoia+=1;break;case"LoseParanoia":{if(s.includes(o))break;const t=a.characterStats[o].paranoia;a.characterStats[o].paranoia=Math.max(0,t-1);break}case"GainGoodwill2":if(s.includes(o))break;a.characterStats[o].goodwill+=2;break;case"GainGoodwill":if(s.includes(o))break;a.characterStats[o].goodwill+=1}}else if(2===t.length){const[e,o]=t,r=new Set([e.actionId,o.actionId]),l=c;if(r.has("ForbidIntrigue")&&(r.has("GainIntrigue")||r.has("GainIntrigue2")))continue;if(r.has("ForbidMove")&&(r.has("DiagonalMove")||r.has("VerticalMove")||r.has("HorizontalMove")))continue;if(r.has("VerticalMove")&&r.has("HorizontalMove")&&!s.includes(l)){const t=l,e=n(t);if(!e)continue;let o;"Hospital"===e?o="School":"School"===e?o="Hospital":"City"===e?o="Shrine":"Shrine"===e&&(o="City"),o&&i(t,o,a);continue}if(r.has("GainParanoia")&&r.has("LoseParanoia"))continue;if(r.has("ForbidParanoia")&&(r.has("GainParanoia")||r.has("LoseParanoia")))continue;if(r.has("ForbidGoodwill")&&(r.has("GainGoodwill")||r.has("GainGoodwill2")))continue;for(const u of t){const t=c;switch(u.actionId){case"GainIntrigue2":s.includes(t)?a.locations[t].intrigue+=2:a.characterStats[t].intrigue+=2;break;case"GainIntrigue":s.includes(t)?a.locations[t].intrigue+=1:a.characterStats[t].intrigue+=1;break;case"UselessLocationCover":case"ForbidParanoia":case"ForbidGoodwill":case"ForbidMove":default:break;case"DiagonalMove":if(!s.includes(t)){const e=t,o=n(e);if(!o)break;let r;"Hospital"===o?r="School":"School"===o?r="Hospital":"City"===o?r="Shrine":"Shrine"===o&&(r="City"),r&&i(e,r,a)}break;case"VerticalMove":if(!s.includes(t)){const e=t,o=n(e);if(!o)break;let r;"Hospital"===o?r="City":"City"===o?r="Hospital":"Shrine"===o?r="School":"School"===o&&(r="Shrine"),r&&i(e,r,a)}break;case"HorizontalMove":if(!s.includes(t)){const e=t,o=n(e);if(!o)break;let r;"Hospital"===o?r="Shrine":"Shrine"===o?r="Hospital":"City"===o?r="School":"School"===o&&(r="City"),r&&i(e,r,a)}break;case"GainParanoia":if(s.includes(t))break;a.characterStats[t].paranoia+=1;break;case"LoseParanoia":{if(s.includes(t))break;const e=a.characterStats[t].paranoia;a.characterStats[t].paranoia=Math.max(0,e-1);break}case"GainGoodwill2":if(s.includes(t))break;a.characterStats[t].goodwill+=2;break;case"GainGoodwill":if(s.includes(t))break;a.characterStats[t].goodwill+=1}}}}return a}async computeUtilityValue(t,e,o){const a=new Map;for(const s of e)a.set(s.id,s);const r=new Map,n=e=>{if(r.has(e))return r.get(e);const o=a.get(e),i=(0,l[o.type])(o.params,t,n);return r.set(e,i),i};let i=0;for(const s of o)n(s.ruleId)&&(i+=s.value);return i}}function h(t){const e=Object.entries(t).filter((t=>{let[,e]=t;return Array.isArray(e)&&e.length>0})).map((t=>{let[e,o]=t;return[e,[...o].sort()]}));return e.sort(((t,e)=>t[0].localeCompare(e[0]))),JSON.stringify(e)}let d,p=!1;function S(t,e){if(0===e)return[[]];if(t.length<e)return[];const[o,...a]=t;return[...S(a,e-1).map((t=>[o,...t])),...S(a,e)]}function b(t,e,o){const a=[];t.worstValue!==1/0&&a.push({value:t.worstValue,count:t.worstCount,example:t.worstExample}),t.secondWorstValue!==1/0&&a.push({value:t.secondWorstValue,count:t.secondWorstCount,example:t.secondWorstExample}),t.thirdWorstValue!==1/0&&a.push({value:t.thirdWorstValue,count:t.thirdWorstCount,example:t.thirdWorstExample}),void 0!==e&&a.push({value:e,count:1,example:o});const r=new Map;for(const i of a)if(r.has(i.value)){r.get(i.value).count+=i.count}else r.set(i.value,{count:i.count,example:i.example});const n=Array.from(r.entries()).map((t=>{let[e,{count:o,example:a}]=t;return{value:e,count:o,example:a}})).sort(((t,e)=>t.value-e.value)).slice(0,3);n[0]?(t.worstValue=n[0].value,t.worstCount=n[0].count,t.worstExample=n[0].example):(t.worstValue=1/0,t.worstCount=0),n[1]?(t.secondWorstValue=n[1].value,t.secondWorstCount=n[1].count,t.secondWorstExample=n[1].example):(t.secondWorstValue=1/0,t.secondWorstCount=0),n[2]?(t.thirdWorstValue=n[2].value,t.thirdWorstCount=n[2].count,t.thirdWorstExample=n[2].example):(t.thirdWorstValue=1/0,t.thirdWorstCount=0)}async function g(t,e,o,a,s,c,l,u){if(p)return;const f=Object.keys(t).filter((e=>t[e]>0)),g=new Set,m={},y=async w=>{if(p)return;if(w===f.length){const t=new Set;f.forEach((e=>{(m[e]||[]).forEach((e=>{t.add(e)}))}));const o=r({},a);if(a.ForbidIntrigue){const e=a.ForbidIntrigue.filter((e=>t.has(e)));o.ForbidIntrigue=e}if(a.ForbidMove){const e=a.ForbidMove.filter((e=>t.has(e)));o.ForbidMove=e}const g=h(m),y=function(t,e,o){const a=[],n={};return function o(i,s){if(i===t.length)return void(0===s&&a.push(r({},n)));const c=t[i],l=Math.min(e[c],s);for(let t=0;t<=l;t++)n[c]=t,o(i+1,s-t)}(0,o),a}(i,e,3);for(const e of y){if(p)return;const t=Object.keys(e).filter((t=>e[t]>0)),a=new Set,f={},y=async w=>{if(p)return;if(w===t.length){const t=await u.compute({mastermindPlacement:m,protagonistPlacement:f,boardState:s,utilities:c,values:l}),e=h(f);if(!d.mastermindStats[g]){const t={};i.forEach((e=>{t[e]=[]}));const e={};n.forEach((t=>{e[t]=[]})),d.mastermindStats[g]={placement:JSON.parse(JSON.stringify(m)),worstValue:1/0,worstCount:0,worstExample:r({},t),secondWorstValue:1/0,secondWorstCount:0,secondWorstExample:r({},t),thirdWorstValue:1/0,thirdWorstCount:0,thirdWorstExample:r({},t)}}if(b(d.mastermindStats[g],t,JSON.parse(JSON.stringify(f))),!d.protagonistStats[e]){const t={};n.forEach((e=>{t[e]=[]}));const o={};i.forEach((t=>{o[t]=[]})),d.protagonistStats[e]={placement:JSON.parse(JSON.stringify(f)),worstValue:1/0,worstCount:0,worstExample:r({},t),secondWorstValue:1/0,secondWorstCount:0,secondWorstExample:r({},t),thirdWorstValue:1/0,thirdWorstCount:0,thirdWorstExample:r({},t)}}if(b(d.protagonistStats[e],t,JSON.parse(JSON.stringify(m))),d.processedCount+=1,d.processedCount%5e3===0){const t={type:"progress",processed:5e3};globalThis.postMessage(t)}return}const v=t[w],k=e[v],C=S((o[v]||[]).filter((t=>!a.has(t))),k);for(const t of C){if(p)return;t.forEach((t=>a.add(t))),f[v]=t,await Promise.resolve(),await y(w+1),t.forEach((t=>a.delete(t)))}};await y(0)}return}const v=f[w],k=t[v],C=S((o[v]||[]).filter((t=>!g.has(t))),k);for(const t of C){if(p)return;t.forEach((t=>g.add(t))),m[v]=t,await Promise.resolve(),await y(w+1),t.forEach((t=>g.delete(t)))}};await y(0)}globalThis.addEventListener("message",(t=>{const e=t.data;"start"===e.type?(p=!1,async function(t,e,o,a,r,n,i){d={mastermindStats:{},protagonistStats:{},processedCount:0};const s=new f;for(const u of t){if(p)break;await g(u,e,o,a,r,n,i,s)}const c=d.processedCount%5e3;if(c>0){const t={type:"progress",processed:c};globalThis.postMessage(t)}const l={type:"done",localMastermindStats:d.mastermindStats,localProtagonistStats:d.protagonistStats};globalThis.postMessage(l),globalThis.close()}(e.sliceDistributions,e.protagonistConfig,e.mastermindScope,e.protagonistScope,e.boardState,e.utilities,e.values)):"cancel"===e.type&&(p=!0)}))}}]);
//# sourceMappingURL=969.e7aa5337.chunk.js.map